package nodagumi.ananPJ;

import java.awt.BorderLayout;
import java.awt.event.WindowEvent;
import java.awt.event.WindowListener;
import java.io.BufferedInputStream;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.FileWriter;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.io.PipedOutputStream;
import java.io.PrintStream;
import java.io.PrintWriter;
import java.io.Serializable;
import java.net.Socket;
import java.net.ConnectException;
import java.net.UnknownHostException;
import java.util.Properties;

import javax.swing.JFrame;

import org.w3c.dom.Document;

import org.apache.commons.cli.BasicParser;
import org.apache.commons.cli.CommandLine;
import org.apache.commons.cli.CommandLineParser;
import org.apache.commons.cli.HelpFormatter;
import org.apache.commons.cli.OptionBuilder;
import org.apache.commons.cli.Options;
import org.apache.commons.cli.ParseException;
import org.apache.commons.cli.MissingOptionException;

import nodagumi.ananPJ.NetworkMap;
import nodagumi.ananPJ.NetmasCuiSimulator;
import nodagumi.ananPJ.Agents.EvacuationAgent;
import nodagumi.ananPJ.Simulator.EvacuationModelBase;
import nodagumi.ananPJ.Simulator.EvacuationSimulator;
import nodagumi.ananPJ.Simulator.SimulationPanel3D;
import nodagumi.ananPJ.BasicSimulationLauncher;

import nodagumi.ananPJ.misc.CommunicationHandler;
import nodagumi.ananPJ.misc.CommunicationHandler.CommunicationType;
import nodagumi.ananPJ.misc.NetMASIOHandler;
import nodagumi.ananPJ.misc.NetMASTimer;
import nodagumi.ananPJ.misc.Snapshot;

import nodagumi.ananPJ.network.DaRuMaClient;


public class NetmasPlayer extends BasicSimulationLauncher
        implements Serializable {

    protected int bufsize = 1024;

    private EvacuationSimulator model;

    private static boolean isDebug = false; // debug mode
    private static String addr = null;      // IP address of destination host
    private static int port = -1;           // port number of destination host
    private static int interval = 100;      // sleep time(msec) during loop

    private static String propertiesPath = null;    // java.util.Properties
    private static String serializeFile = null;    // path to serialized file
    private static String timerFile = null;         // path to timer log file
    private static String deserializeFile = null;

    private static ObjectOutputStream oos = null;
    private static boolean isTimerEnabled = false;
    private static int counter;
    private static boolean isDeserialized = false;
    private static boolean finished = false;

    private transient NetMASIOHandler handler = null;

    private static CommunicationType type = null;   // file or pipe or network
    private static NetMASTimer timer = null;
    private DaRuMaClient darumaClient = DaRuMaClient.getInstance();

    protected transient SimulationPanel3D panel = null;
    protected transient JFrame simulation_frame = null;

    public NetmasPlayer(String title) {
        super();
    }

    private static NetmasCuiSimulator ncs = null;
    private String scenarioSerial = null;
    //private void envokeSimulator(NetworkMap network_map) {
    private void envokeSimulator() {

        handler = new NetMASIOHandler(type, isDebug, addr, port,
                serializeFile, null);
        handler.start();

        Object obj = null;
        panel = new SimulationPanel3D(null, null);
        while(true) {
            obj = handler.readStream();
            if (obj != null) {
                if (ncs == null) {
                    NetmasCuiSimulator ncs = (NetmasCuiSimulator) obj;
                    model = (EvacuationSimulator) ncs.getModel();
                } else {
                    model = (EvacuationSimulator) ((NetmasCuiSimulator) obj)
                        .getModel();
                }
                model.begin(true, true, panel);
                System.err.println("NetmasPlayer.envokeSimulator model tick" +
                        " count: " + model.getTickCount());

                //if (panel == null) {
                    //ncs = tmpncs;
                    //panel = setupFrame(ncs.getModel());
<<<<<<< HEAD
                //    panel = ((EvacuationSimulator) ncs.getModel())
                        .getPanel3D();
                //    panel.setVisible(true);
=======
                    //panel = ((EvacuationSimulator) ncs.getModel())
                    //    .getPanel3D();
                    //panel.setVisible(true);
>>>>>>> fba42ab37a51652aebe5c00d14f68b9f1ea0b779
                //} else {
                    // EvacuationSimulator tmpes = ((EvacuationSimulator)
                            // ncs.getModel());
                    // tmpes = (EvacuationSimulator) tmpncs.getModel();
<<<<<<< HEAD
                //    ((EvacuationSimulator) ncs.getModel())
                //        .updateWithSerialize();
=======
                    //((EvacuationSimulator) ncs.getModel())
                    //    .updateWithSerialize();
>>>>>>> fba42ab37a51652aebe5c00d14f68b9f1ea0b779
                //}
                //panel.repaint();
            } else {
                try {
                    Thread.sleep(interval);
                } catch (InterruptedException ie) {
                    ie.printStackTrace();
                }
            }

            //else // update
                //panel.updateClock();
        }
    }


    public SimulationPanel3D setupFrame(EvacuationModelBase model) {
        simulation_frame = new JFrame("Simulation Preview");

        simulation_frame.addWindowListener(new WindowListener() {
            public void windowOpened(WindowEvent e) {           }
            public void windowIconified(WindowEvent e) {            }
            public void windowDeiconified(WindowEvent e) {          }
            public void windowDeactivated(WindowEvent e) {          }
            public void windowClosing(WindowEvent e) {
                finished = true;
            }
            public void windowActivated(WindowEvent e) {            }
            public void windowClosed(WindowEvent e) {           }
        });

        panel = new SimulationPanel3D(model, simulation_frame);
        //int w = settings.get("3dpanel_width", 400);
        //int h = settings.get("3dpanel_height", 300);
        int w = 400;
        int h = 300;
        panel.setCanvasSize(w, h);
        panel.initialize();
        simulation_frame.setLayout(new BorderLayout());
        simulation_frame.add(panel, BorderLayout.CENTER);
        /*
        JTabbedPane tabs = new JTabbedPane();
        simulation_frame.add(tabs, BorderLayout.EAST);
        panel.addViewChangeListener(this);

        dump_state = new DumpState(model);

        tabs.add(model.getAgentHandler().getControlPanel());
        tabs.add(panel.getControlPanel());
        tabs.add(dump_state.getDumpPanel());
        */
        simulation_frame.setMenuBar(panel.getMenuBar());
        simulation_frame.pack();
        simulation_frame.setVisible(true);

        return panel;
    }

    static NetmasPlayer instance = null;
    public static NetmasPlayer getInstance() {
        if (instance == null) {
            instance = new NetmasPlayer("NetmasPlayer");
        }
        return instance;
    }

    private void printInputtedOptions() {
        System.err.flush();
        System.out.flush();
        System.out.println("--- NetmasPlayer: inputted options ---");
        System.out.println("  type:        " +
                CommunicationHandler.CommunicationType2String(type));

        System.out.println("  debug mode:  " + isDebug);
        //System.out.println("  addr:        " + addr);
        System.out.println("  port:        " + port);
        System.out.println("  serialized:  " + serializeFile);
        System.out.println("  timer log:   " + timerFile);
        System.out.println("--------------------------------------------");
        System.out.flush();
    }

    private static void printHelp(Options options) {
            HelpFormatter formatter = new HelpFormatter();
            formatter.printHelp("NetmasPlayer", options, true);
    }

    private static String getProperty(Properties prop, String key) {
        if (prop.containsKey(key)) {
            return prop.getProperty(key);
        } else {
            return null;
        }
    }

    public static void main(String[] args) throws IOException {

        Options options = new Options();
        options.addOption(OptionBuilder.withArgName("properties_file")
                .hasArg(true).withDescription("Path of properties file")
                .isRequired(true).create("p"));

        CommandLineParser parser = new BasicParser();
        CommandLine cli = null;

        try {
            cli = parser.parse(options, args);
        } catch (MissingOptionException moe) {
            moe.printStackTrace();
            HelpFormatter formatter = new HelpFormatter();
            formatter.printHelp("NetmasPlayer", options, true);
            System.exit(1);
        } catch (ParseException e) {
            e.printStackTrace();
            System.exit(1);
        }
        propertiesPath = cli.getOptionValue("p");

        // load properties
        Properties prop = new Properties();
        try {
            prop.loadFromXML(new FileInputStream(propertiesPath));

            String typestr = getProperty(prop, "type");
            if (typestr == null)
                type = CommunicationType.RCV_FILE;
            else if (typestr.equals("buffer"))
                type = CommunicationType.RCV_BUFFER;
            else if (typestr.equals("file"))
                type = CommunicationType.RCV_FILE;
            else if (typestr.equals("pipe"))
                type = CommunicationType.RCV_PIPE;
            else if (typestr.equals("network"))
                type = CommunicationType.RCV_NETWORK;
            else {
                System.err.println("NetmasPlayer: invalid inputted " +
                        "type:" + typestr);
                type = CommunicationType.NONE;
            }
            String debugstr = getProperty(prop, "debug");
            if (debugstr == null)
                isDebug = false;
            else if (debugstr.equals("true"))
                isDebug = true;
            String timerstr = getProperty(prop, "timer");
            if (timerstr == null)
                isTimerEnabled = false;
            else if (timerstr.equals("true"))
                isTimerEnabled = true;
            timerFile = getProperty(prop, "timer_file");
            addr = getProperty(prop, "addr");
            String portString = getProperty(prop, "port");
            if (portString != null)
                port = Integer.parseInt(portString);
            String intervalString = getProperty(prop, "interval");
            if (intervalString != null)
                interval = Integer.parseInt(intervalString);
            serializeFile = getProperty(prop, "serialize_file");
            deserializeFile = getProperty(prop, "deserialized_file");
        } catch (IOException ioe) {
            ioe.printStackTrace();
        }

        // check inputted options
        if (type == CommunicationType.NONE) {
            System.err.println("NetmasPlayer: invalid type:" +
                    type);
            printHelp(options);
            System.exit(1);
        } else if (type == CommunicationType.RCV_FILE &&
                deserializeFile == null) {
            System.err.println("NetmasPlayer: file mode requires a " +
                    "deserialize file.");
            printHelp(options);
            System.exit(1);
        } else if (type == CommunicationType.RCV_NETWORK && port <= 0) {
            System.err.println("NetmasPlayer: network mode " +
                    "requires port number.");
            printHelp(options);
            System.exit(1);
        }

        NetmasPlayer sim = NetmasPlayer.getInstance();
        sim.printInputtedOptions();
        sim.envokeSimulator();
        /*
        if (deserializeFile == null) {
            NetmasPlayer sim = NetmasPlayer.getInstance();
            sim.printInputtedOptions();
            NetworkMap networkMap = sim.readMapWithName(mPath);
            sim.scenarioSerial = "NetMASNetmasPlayer";
            sim.envokeSimulator(networkMap);
        } else {
            try {
                FileInputStream fis = new FileInputStream(deserializeFile);
                ObjectInputStream ois = new ObjectInputStream(fis);
                NetmasPlayer sim = (NetmasPlayer) ois.readObject();
                sim.isDeserialized = true;
                sim.printInputtedOptions();
                sim.envokeSimulator(sim.model.getMap());
            } catch (IOException ioe) {
                ioe.printStackTrace();
            } catch (ClassNotFoundException cnfe) {
                cnfe.printStackTrace();
            }
        }
        */
    }
}

