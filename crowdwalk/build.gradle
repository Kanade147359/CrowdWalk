/**
 * build.gradle
 *  generates executable jar using Gradle.
 */

import org.apache.tools.ant.filters.ReplaceTokens

// defaultTasks 'clean', 'build', 'javadoc'
defaultTasks 'clean', 'build'

apply plugin: 'java'
apply plugin: 'eclipse'

// [2016.04.08 I.Noda]
// コンパイル時に VM のバージョンを指定してみる。
// 今のところ、まだうまく動かない。
//targetCompatibility = '1.8' ;
//sourceCompatibility = '1.6' ;

def javaVersion = new Double(sourceCompatibility.toString())
def onlyCuiSimulator = cui.toBoolean()

if (javaVersion < 1.8) {
    println "javaVersion ${javaVersion}"
    onlyCuiSimulator = true
}
if (onlyCuiSimulator) {
    println "build mode: onlyCuiSimulator"
}

repositories {
    mavenCentral()
}

dependencies {
    compile localGroovy()   // Gradleに同梱されているGroovyを使う
    compile 'commons-cli:commons-cli:1.2'
    compile 'commons-codec:commons-codec:1.10'
    compile 'org.apache.xmlgraphics:batik-awt-util:1.8'
    compile 'xalan:xalan:2.7.0'
    compile 'net.arnx:jsonic:1.3.7'
    compile 'net.sf.opencsv:opencsv:2.3'
    compile 'junit:junit:4.12'
//    compile 'org.jruby:jruby:9.+'
    compile 'org.osgeo:proj4j:0.1.0'
    compile 'math.geom2d:javaGeom:0.11.1'
    compile fileTree(dir: 'libs/jar', include: '*.jar')

    if (! onlyCuiSimulator) {
        runtime fileTree(dir: 'libs/windows/amd64', include: '*.dll')
        runtime fileTree(dir: 'libs/windows/i386', include: '*.dll')
        runtime fileTree(dir: 'libs/linux/amd64', include: '*.so')
        runtime fileTree(dir: 'libs/linux/i386', include: '*.so')
        runtime fileTree(dir: 'libs/macosx', include: '*.jnilib')
    }
}

sourceSets {
    main {
        java {
            if (onlyCuiSimulator) {
                exclude 'nodagumi/ananPJ/CrowdWalkLauncher.java'
                exclude 'nodagumi/ananPJ/GuiSimulationEditorLauncher.java'
                exclude 'nodagumi/ananPJ/GuiSimulationLauncher.java'
                exclude 'nodagumi/ananPJ/GuiSimulationLauncher2D.java'
                exclude 'nodagumi/ananPJ/GuiSimulationLauncher3D.java'
                exclude 'nodagumi/ananPJ/Settings.java'
                exclude 'nodagumi/ananPJ/ImportGis.java'
                exclude 'nodagumi/ananPJ/Editor/**'
                exclude 'nodagumi/ananPJ/Gui/**'
                exclude 'nodagumi/ananPJ/misc/GetDoublesDialog.java'
                exclude 'nodagumi/ananPJ/misc/GridMapAreaDialog.java'
                exclude 'nodagumi/ananPJ/misc/GsiAccessor.java'
                exclude 'nodagumi/ananPJ/misc/Hover.java'
                exclude 'nodagumi/ananPJ/misc/MapChecker.java'
                exclude 'nodagumi/ananPJ/Simulator/SimulationPanel3D.java'
            } else {
                exclude 'nodagumi/ananPJ/CuiCrowdWalkLauncher.java'
            }
            exclude 'nodagumi/ananPJ/ImportGis.java'
        }
    }
}

def defaultEncoding = 'UTF-8'

compileJava {
    options.encoding = defaultEncoding
//    options.compilerArgs = ['-Xlint:unchecked', '-Xdiags:verbose'] 
    options.compilerArgs = ['-Xdiags:verbose']
}

processResources {
    doFirst {
        // バージョン番号を生成してリソースファイルにセットする
        def version = new File("version.txt").getText().trim()
        def branch = "git rev-parse --abbrev-ref HEAD".execute().text.trim()
        def revision = 0
        "git rev-list HEAD".execute().in.eachLine { revision++ }
        def commit_hash = "git rev-parse --short HEAD".execute().text.trim()

        filesMatching("CrowdWalk.properties") {
            filter(ReplaceTokens, tokens: ['version': version])
            filter(ReplaceTokens, tokens: ['branch': branch])
            filter(ReplaceTokens, tokens: ['revision': "" + revision])
            filter(ReplaceTokens, tokens: ['commit_hash': commit_hash])
        }
        println "    version -> ${version}.${branch}.${revision}-${commit_hash}"
    }
}

jar {
    if (onlyCuiSimulator) {
        manifest.mainAttributes("Main-Class" : "nodagumi.ananPJ.CuiCrowdWalkLauncher")
    } else {
        manifest.mainAttributes("Main-Class" : "nodagumi.ananPJ.CrowdWalkLauncher")
    }
    doFirst {
        from (configurations.compile.collect { it.isDirectory() ? it : zipTree(it) }) {
            exclude 'META-INF/MANIFEST.MF'
            exclude 'META-INF/*.SF'
            exclude 'META-INF/*.DSA'
            exclude 'META-INF/*.RSA'
        }
    }
}

task javadoc(overwrite: true) << {
    exec {
        executable "sh"
        args "-c", "./make_javadoc.sh"
    }
}

task clearCache() {
    doFirst {
        File f = file("${System.getProperty("user.home")}/.gradle/cache/${project.group}/${project.name}")
        println("Deleting gradle cache at ${f.absolutePath}")
        delete(f)
    }
}

/* [2015.01.28 I.Noda] gradle でトラブルと、どうもここが怪しい。
 * なので、いざという時、クリアできるようにしておく。
 */
task cleanAll {
     doFirst {
       File f = file("./.gradle") ;
       println("deleting ${f.absolutePath}") ;
       delete(f) ;
     }
}
